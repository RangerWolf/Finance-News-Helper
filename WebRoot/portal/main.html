<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="author" content="">
<link rel="icon" href="../../favicon.ico">

<title>股事先知</title>

<!-- Bootstrap core CSS -->
<link href="${base}/portal/css/bootstrap.min.css" rel="stylesheet">

<!-- Custom styles for this template -->
<link href="${base}/portal/css/main.css" rel="stylesheet">

<!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
<!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
<script src="${base}/portal/js/ie-emulation-modes-warning.js"></script>

<!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
<script src="${base}/portal/js/ie10-viewport-bug-workaround.js"></script>
<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>

<body>
<#-- 在打开这个页面的时候，先把原来用户的信息存储进来 -->
<input class="hidden" type="text" id="useremail" name="user.email" value="${user.email!'出错啦'}"/>
<textarea class="hidden" id="userkeywords" name="user.keywords">${user.keywords!''}</textarea>
<textarea class="hidden" id="userstocks" rows="" cols="" name="user.stocks">${user.stocks!''}</textarea>


	<div class="container">
		<div class="header">
			<ul class="nav nav-pills pull-right">
				<li><a href="javascript:void(0)">欢迎你!${session.login_email}</a></li>
				<li><a href="${base}/logout">退出</a></li>
			</ul>
			<h3 class="text-muted">股事先知</h3>
		</div>

		<div class="row">
			<div class="col-lg-8">
				<h4 style="font-weight: bold">您关注的股票</h4>
			</div>
			<div class="col-lg-4">
				<div class="input-group pull-right" id="addStock">
					<input id="stockCode" class="form-control" type="email"
						placeholder="输入股票代码或中文" name="stockCode">
					<div class="input-group-addon" style="cursor: pointer;"
						id="addStockBtn">添加</div>
				</div>

				<!-- 显示选择股票的窗口Modal -->
				<div class="modal fade" id="addStockModal" tabindex="-1"
					role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
					<div class="modal-dialog">
						<div class="modal-content">
							<div class="modal-header">
								<button type="button" class="close" data-dismiss="modal">
									<span aria-hidden="true">&times;</span><span class="sr-only">Close</span>
								</button>
								<h4 class="modal-title" id="myModalLabel">选择股票</h4>
							</div>
							<div class="modal-body">
								<table class="table table-condensed" id="chooseStockTable">
									
								</table>

							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-default"
									data-dismiss="modal">关闭</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="row" style="margin-top: 15px">
			<!-- Table -->
			<table class="table table-hover" id="stockTable">
				<tr>
					<th>代码</th>
					<th>名称</th>
					<th>昨收</th>
					<th>当前价</th>
					<th>涨跌额</th>
					<th>涨跌幅</th>
					<th>最高</th>
					<th>最低</th>
					<th>操作</th>
				</tr>
				<tr id="loadingRow">
					<td colspan="9">正在加载...</td>
				</tr>
				<tr id="noTargetStock" class="hidden">
					<td colspan="9">您目前没有关注任何股票</td>
				</tr>
			</table>

		</div>

		<div class="jumbotron hidden">
			<h1>Jumbotron heading</h1>
			<p class="lead">Cras justo odio, dapibus ac facilisis in, egestas
				eget quam. Fusce dapibus, tellus ac cursus commodo, tortor mauris
				condimentum nibh, ut fermentum massa justo sit amet risus.</p>
			<p>
				<a class="btn btn-lg btn-success" href="#" role="button">Sign up
					today</a>
			</p>
		</div>
		
		<div class="row">
			<div class="panel panel-default">
			  <div class="panel-heading">
			    <h3 class="panel-title" style="font-weight:bold">您关注的关键词
			    	<span class="badge pull-right" style="color:black; background-color:rgba(0,0,0,0);font-weight:normal">*<label style="color:red">双击</label>直接删除关注的关键词</span>
			    </h3>
			  </div>
			  <div class="panel-body" id="keywordHolder">
			  </div>
			  <div class="panel-footer">
			  	<div class="input-group" style="width:30%" >
				  <input type="text" class="form-control" placeholder="添加新的关键字" id="newKeywordTxt">
				  <span class="input-group-addon" style="cursor:pointer" id="addKeywordBtn">确定</span>
				</div>
			  
			  </div>
			</div>
		</div>
		<div class="row">
			<div class="panel panel-default">
			  <div class="panel-heading">
			    <h3 class="panel-title" style="font-weight:bold">最新消息预览
			    	<span class="badge pull-right" style="color:black; background-color:rgba(0,0,0,0);font-weight:normal">*根据您选中的关键词筛选出<label style="color:red">10小时以内</label>的新闻</span>
			    </h3>
			  </div>
			  <div class="panel-body" id="latestNewsHolder" style="height: 250px;overflow-y:scroll;">
			  	<!-- Template 
			  	<div>
				  	<span style="">乐视X50 Air 超多APP海量视频资源_客厅好选择7款京东热卖大屏4K电视推荐</span>
				  	<span class="pull-right">2014-08-20 12:53</span>
			  	</div>
			  	 -->
			  	 <p id="noNewsTip" class="hidden">暂时没有更多的新闻</p>
			  </div>
			  <div class="panel-footer">
			  <button class="btn btn-success btn-sm" onclick="showLatestNews()">
			  	<span class="glyphicon glyphicon-refresh"></span> 刷新
			  </button>
			  <button class="btn btn-success btn-sm" id="notifyBtn">
			  	<span class="glyphicon glyphicon-send"></span>  向我的邮箱发送消息
			  </button>	
			  </div>
			</div>
		</div>
		
		<div class="row marketing hidden">
			<div class="col-lg-12">
				<h6>Subheading</h6>
				<p>Donec id elit non mi porta gravida at eget metus. Maecenas
					faucibus mollis interdum.</p>

				<h4>Subheading</h4>
				<p>Morbi leo risus, porta ac consectetur ac, vestibulum at eros.
					Cras mattis consectetur purus sit amet fermentum.</p>

				<h4>Subheading</h4>
				<p>Maecenas sed diam eget risus varius blandit sit amet non
					magna.</p>
			</div>

		</div>

		<div class="footer">
			<p>&copy; 先知股事 2014</p>
		</div>

	</div>
	<!-- /container -->


	<!-- Bootstrap core JavaScript
================================================== -->
	<!-- Placed at the end of the document so the pages load faster -->
	<!-- jQuery Version 1.11.0 -->
	<script src="${base}/portal/js/jquery-1.11.0.js"></script>

	<!-- Bootstrap Core JavaScript -->
	<script src="${base}/portal/js/bootstrap.min.js"></script>

	<!-- Bootstrap Core JavaScript -->
	<script src="${base}/portal/js/dateformat.js"></script>

	<!-- Action Script -->
	<script type="text/javascript">
	// 设置不同的执行时间，防止request一起发出影响服务器性能
	setTimeout(updateStockTable(), 1000);
	setInterval(updateStockTable, 30000);
	setTimeout(showLatestNews, 500);
	showKeywords();
	
	// ajax 访问后台api进行股票查询 当返回的结果只有1个的时候直接使用，0个的时候alert，多个的时候弹出modal让用户选择
	$("#addStockBtn").click(function() {
		var q = $("#stockCode").val();
		if (q.length > 0) {
			addNewStock(q)
		}
	});
	
	function addNewStock(stockCode) {
		$.ajax({
			url : "${base}/stock/search",
			method : "get",
			dataType : "json",
			data : {
				q : stockCode
			},
			success : function(data) {
				if (data.length == 0) {
					alert("没有找到任何股票");
				} else if (data.length == 1) {
					var originalStockStr = $("#userstocks").val(); 
					var originalKeywordStr = $("#userkeywords").val();
					
					var symbol = data[0].symbol;
					var type = data[0].type;
					var name = data[0].name;
					// build stockCode
					var stockCode = type + "_" + symbol; // 比如 US_GOOG
					if(type=="SH") stockCode = "0" + symbol;
					else if(type == "SZ") stockCode = "1" + symbol;
					if(originalStockStr.indexOf(stockCode) == -1 ) {
						$("#userstocks").val(originalStockStr + stockCode + ",")	// 将新的stockCode写到本地目录
						if(originalKeywordStr.indexOf(name) == -1) $("#userkeywords").val(originalKeywordStr + name + ",");
						addKeywordInUI(name);
						updateUserSetting();
					} else {
						alert("此股票您已经添加");
					}
					
				} else if (data.length > 1) {
					// 在chooseStockTable之中添加表格						
					chooseStockTable = $("#chooseStockTable")
					$(".stockChooseList").remove();
					for(var i = 0; i < data.length; i++) {
						row = $("<tr class='stockChooseList'></tr>")
						row.append("<td>" + (i+1) + "</td>")
						row.append("<td>" + data[i].symbol + "</td>")
						row.append("<td>" + data[i].name + "</td>")
						row.append('<td><button type="button" class="btn btn-primary btn-xs choose-stock-btn" id="' + data[i].symbol + '">关注此股</button></td>')
						chooseStockTable.append(row)
					}
					
					$(".choose-stock-btn").unbind("click").click(function(){
						id = $(this).attr("id")
						addNewStock(id)
						$('#addStockModal').modal('hide')
					});
					
					$('#addStockModal').modal('toggle')
				}
			},
			error : function() {
				alert("出错啦！请再试一遍！")
			}

		});
	}
	
	function updateUserSetting() {
		$.ajax({
			url : "${base}/user/updateUserSetting",
			dataType : "JSON",
			method : "post",
			data : {
				keyword: $("#userkeywords").val(),
				stock: $("#userstocks").val()
			}
		}).done(function(data) {
			updateStockTable();
		});
	}

	/**
	更新表格，将用户选择的股票显示出来
	 */
	function updateStockTable() {
		var stockStr = $("#userstocks").val();
		if(stockStr.length == 0) {
			$("#loadingRow").addClass("hidden")
			$("#noTargetStock").removeClass("hidden")
		} else {
			if($("#stockTable tr").length == 2)
				$("#loadingRow").removeClass("hidden")
				
			$("#noTargetStock").addClass("hidden")
			$.ajax({
				url : "${base}/stock/query",
				dataType : "JSON",
				method : "post",
				data : {
					stock: $("#userstocks").val()
				}
			}).done(function(data) {
				$.each(data, function(i, item) {
					console.log("i=" + i)
					updateRow(item);
				});
				$("#loadingRow").addClass("hidden")
			});
		}
	}

	function updateRow(data) {
		if($("#" + data.code).length ==  0) {
			addRow(data);
		}
		fieldArr = ["price", "updown", "percent", "high", "low"]
		baseNumber = [data.yestclose, 0, 0, data.yestclose, data.yestclose]
		for(var i = 0; i < fieldArr.length; i++) {
			var pre = "<span style='color:rgb(218,48,48)'>"
			if(parseFloat(data[fieldArr[i]]) < parseFloat(baseNumber[i])) pre = "<span style='color:rgb(15,153,15)'>";
			end = "</span>"
			if(fieldArr[i] == "percent") {
				n = data[fieldArr[i]];
				p =	(n*100).toFixed(2)+"%";
				$("#" + data.code + " td[name='" + fieldArr[i] +"']").html( pre + p + end);
			} else {
				$("#" + data.code + " td[name='" + fieldArr[i] +"']").html( pre + data[fieldArr[i]] + end);	
			}
			
		}
	}

	function addRow(data) {
		rowStr = '<tr id="' + data.code + '">' + 
				'<td style="width: 75px; color: rgb(0, 160, 206)">' + data.symbol + '</td>' +
				'<td style="color: rgb(0, 160, 206)">' + data.name + '</td>' +
				'<td name="yestclose">' + data.yestclose + '</td>' +
				'<td name="price"></td>' +
				'<td name="updown"></td>' +
				'<td name="percent"></td>' +
				'<td name="high"></td>' +
				'<td name="low"></td>' +
				'<td name="action"><button type="button" class="btn btn-default btn-xs remove-stock-btn" id="'+ data.code +'">删除</button></td>' +
			'</tr>';	
		console.log(rowStr)
		row = $(rowStr);
		$("#stockTable").append(row);
		
		$(".remove-stock-btn").unbind("click").click(function(){
			id = $(this).attr("id")
			console.log("id=" + id)
			removeStock(id)
		})
	}
	
	
	function showKeywords() {
		var keywords = $("#userkeywords").val().split(",");
		for(var i = 0; i < keywords.length; i++) {
			addKeywordInUI(keywords[i])
		}
	}
	
	function addKeywordInUI(word) {
		if(word == null || word == undefined || word.length == 0) return;
		label = $('<span class="label label-warning" style="margin:5px;cursor:pointer">' + word + '</span>');
		label.dblclick(function(){
			var curText = $(this).text();
			var totalText = $("#userkeywords").val();
			var newText = totalText.replace(curText + ",", "");
			$("#userkeywords").val(newText);
			updateUserSetting();
			$(this).remove()
		});
		$("#keywordHolder").prepend(label)
	}
	$("#addKeywordBtn").click(function(){
		var curWord = $("#newKeywordTxt").val();
		if(curWord != null && curWord != undefined && curWord.length > 0 && /^[a-zA-z0-9\u4E00-\u9FA5]*$/.test(curWord)) {
			if(curWord.length < 2) {
				alert("关键字的长度不能少于2")
			} 
			else {
				addKeywordInUI(curWord);
				var totalText = $("#userkeywords").val();
				$("#userkeywords").val(totalText + curWord + ",");
				$("#newKeywordTxt").val("");
				updateUserSetting();				
			}
		} else {
			alert("关键字不能为空且不能包含特殊符号")
		}
	});
	
	
	
	function showLatestNews() {
		$("#latestNewsHolder .newsDiv").remove();
		$("#noNewsTip").addClass("hidden")
		$.ajax({
			url : "${base}/user/latestNews",
			dataType : "JSON",
			method : "get"
		}).done(function(data) {
			if(data.length == 0) {
				$("#noNewsTip").removeClass("hidden")
			} else {
				$.each(data, function(i, item) {
					div = $("<div class='newsDiv'></div>");
					// title
					div.append("<span class='badge'  style='width:30px;margin-right:5px'>" + (i + 1) + "</span>");
					title = $("<span><a href='" + item.newsUrl + "' target='_blank'>" + item.title + "</a></span>")
					div.append(title)
					div.append("<span class='pull-right'>" + dateFormat(new Date(item.dateTime), 'yyyy-MM-dd hh:mm:ss') + "</span>")
					$("#latestNewsHolder").append(div);
				});
			}
		});
	}
	
	$("#notifyBtn").click(function(){
		$(this).addClass("disabled");
		$(this).text("正在发送... (已发送的消息不会再次发送)");
		sendMail();
	});
	function sendMail() {
		$.ajax({
			url : "${base}/user/notifyMe",
			dataType : "JSON",
			method : "get"
		}).done(function(data) {
			if(data.length == 0) {
				$("#noNewsTip").removeClass("hidden")
			} else {
				$.each(data, function(i, item) {
					div = $("<div class='newsDiv'></div>");
					// title
					div.append("<span class='badge'  style='width:30px;margin-right:5px'>" + (i + 1) + "</span>");
					title = $("<span><a href='" + item.newsUrl + "' target='_blank'>" + item.title + "</a></span>")
					div.append(title)
					div.append("<span class='pull-right'>" + dateFormat(new Date(item.dateTime), 'yyyy-MM-dd hh:mm:ss') + "</span>")
					$("#latestNewsHolder").append(div);
				});
			}
		}).always(function(){
			setTimeout(enableNotifyBtn, 6000);
		});
	}
	
	function enableNotifyBtn() {
		$("#notifyBtn").removeClass("disabled")
		$("#notifyBtn").text("向我的邮箱发送消息");
	}
	
	function removeStock(id) {
		stocks = $("#userstocks").val()
		stocks = stocks.replace(id + ",", "")
		$("#userstocks").val(stocks)
		updateUserSetting()		
		$("#" + id).remove();
	}
	</script>
</body>
</html>
